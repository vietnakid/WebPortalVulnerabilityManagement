{% extends "index.html" %}

{% block head %}
<meta http-equiv="refresh" content="{{session['auto_refresh']}}">
{% endblock %}

{% block body %}
<div class="container-fluid">

    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Dashboard</h1>
        <label for="">Update every
            <select id="select-auto-refresh" class="custom-select custom-select-sm form-control form-control-sm" style="width: 50%">
                <option value="60" {% if session['auto_refresh'] == 60 %} selected="selected" {% endif %}>
                    1 minute </option>
                <option value="300" {% if session['auto_refresh'] == 300 %} selected="selected" {% endif %}>
                    5 minutes </option>
                <option value="600" {% if session['auto_refresh'] == 600 %} selected="selected" {% endif %}>
                    10 minutes </option>
                <option value="1800" {% if session['auto_refresh'] == 1800 %} selected="selected" {% endif %}>
                    30 minutes </option>
            </select>
        </label>
    </div>

    <!-- Line graphs and Piechart Row -->
    <div class="row">

        <!-- Pie Chart -->
        <div class="col-xl-4 col-lg-5">
            <div class="card shadow mb-4">
                <!-- Header -->
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h5 class="m-0 font-weight-bold text-primary">Vulnerabilities: <span
                            style="color: #e74a3b">{{vul_count.total}}</span></h5>
                </div>
                <!-- Body -->
                <div class="card-body">
                    <div class="chart-pie pt-4 pb-2">
                        <div class="chartjs-size-monitor">
                            <div class="chartjs-size-monitor-expand">
                                <div class=""></div>
                            </div>
                            <div class="chartjs-size-monitor-shrink">
                                <div class=""></div>
                            </div>
                        </div>
                        <canvas id="myPieChart" width="448" height="306" class="chartjs-render-monitor"
                            style="display: block; height: 245px; width: 359px;"></canvas>
                    </div>
                    <div class="mt-4 text-center small">
                        <span class="mr-2">
                            <i class="fas fa-circle" style="color: #1cc88a"></i> Low
                        </span>

                        <span class="mr-2">
                            <i class="fas fa-circle" style="color: #f6c23e"></i> Medium
                        </span>

                        <span class="mr-2">
                            <i class="fas fa-circle" style="color: #f69a3e"></i> Medium-High
                        </span>

                        <span class="mr-2">
                            <i class="fas fa-circle" style="color: #e74a3b"></i> High
                        </span>

                    </div>
                </div>
            </div>
        </div>

        <!-- Area Chart -->
        <div class="col-xl-8 col-lg-7">
            <div class="card shadow mb-4">
                <!-- Card Header - Dropdown -->
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h5 class="m-0 font-weight-bold text-primary">Vulnerabilities through time</h5>
                </div>
                <!-- Card Body -->
                <div class="card-body">
                    <div class="chart-area">
                        <div class="chartjs-size-monitor">
                            <div class="chartjs-size-monitor-expand">
                                <div class=""></div>
                            </div>
                            <div class="chartjs-size-monitor-shrink">
                                <div class=""></div>
                            </div>
                        </div>
                        <canvas id="myAreaChart" width="981" height="400" class="chartjs-render-monitor"
                            style="display: block; height: 320px; width: 785px;"></canvas>
                    </div>
                </div>
            </div>
        </div>


    </div>

    <!-- Vul and Target Row -->
    <div class="row">

        <!-- Vul -->
        <div class="col-lg-6 mb-4">

            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h5 class="m-0 font-weight-bold text-primary">Vulnerabilities: </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <div id="dataTable_wrapper" class="dataTables_wrapper dt-bootstrap4">
                            <!-- Horizontal Table list -->
                            <ul class="nav nav-pills mb-3 nav-fill" id="nav-target" role="tablist">
                                <li class="nav-item">
                                    <a class="nav-link active" id="top-vul-tab" data-toggle="pill" href="#top-vul"
                                        role="tab" aria-controls="top-vul">Top Vulnerabilities</a> </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="recent-vul-tab" data-toggle="pill" href="#recent-vul"
                                        role="tab" aria-controls="recent-vul">Recent Vulnerabilities</a>
                                </li>
                            </ul>
                            <!-- End Horizontal Table list -->

                            <div class="tab-content">
                                <!-- Top Vul -->
                                <div class="tab-pane fade show active" id="top-vul" role="tabpanel"
                                    aria-labelledby="top-vul-tab">
                                    <table class="table table-bordered dataTable" width="100%" cellspacing="0"
                                        role="grid" aria-describedby="dataTable_info" style="width: 100%;">
                                        <!-- Head -->
                                        <thead>
                                            <tr role="row">
                                                <th rowspan="1" colspan="1" style="">Name</th>
                                                <th rowspan="1" colspan="1" style="">Target</th>
                                                <th rowspan="1" colspan="1" style="">CVSS</th>
                                            </tr>
                                        </thead>
                                        <!-- End Head -->

                                        <!-- Body -->
                                        <tbody>
                                            {%for item in vul_critical%}
                                            <tr>
                                                <td><a href="{{item.link}}">{{item.name}}</a></td>
                                                <td>{{item.target}}</td>
                                                <td>
                                                    <span class="vul btn btn-circle"
                                                        {% if item.cvss > 1 and item.cvss <= 3.9 %}
                                                            style="background: #1cc88a"
                                                        {% elif item.cvss > 4 and item.cvss <= 6.9 %}
                                                            style="background: #f6c23e"                                               
                                                        {% elif item.cvss > 7 and item.cvss <= 8.9 %}
                                                            style="background: #f69a3e"
                                                        {% else %}
                                                            style="background: #e74a3b"
                                                        {% endif %} >
                                                    {{item.cvss}}
                                                    </span>
                                                </td>
                                            </tr>
                                            {%endfor%}
                                        </tbody>
                                        <!-- End Body -->
                                    </table>
                                </div>
                                <!-- End Top Vul -->

                                <!-- Recent Vul -->
                                <div class="tab-pane fade" id="recent-vul" role="tabpanel"
                                    aria-labelledby="recent-vul-tab">
                                    <table class="table table-bordered dataTable" width="100%" cellspacing="0"
                                        role="grid" aria-describedby="dataTable_info" style="width: 100%;">
                                        <!-- Head -->
                                        <thead>
                                            <tr role="row">
                                                <th rowspan="1" colspan="1" style="">Name</th>
                                                <th rowspan="1" colspan="1" style="">Target</th>
                                                <th rowspan="1" colspan="1" style="">CVSS</th>
                                            </tr>
                                        </thead>
                                        <!-- End Head -->

                                        <!-- Body -->
                                        <tbody>
                                            {%for item in vul_recent%}
                                            <tr>
                                                <td><a href="{{item.link}}">{{item.name}}</a></td>
                                                <td>{{item.target}}</td>
                                                <td>
                                                    <span class="vul btn btn-circle"
                                                        {% if item.cvss > 1 and item.cvss <= 3.9 %}
                                                            style="background: #1cc88a"
                                                        {% elif item.cvss > 4 and item.cvss <= 6.9 %}
                                                            style="background: #f6c23e"                                               
                                                        {% elif item.cvss > 7 and item.cvss <= 8.9 %}
                                                            style="background: #f69a3e"
                                                        {% else %}
                                                            style="background: #e74a3b"
                                                        {% endif %} >
                                                    {{item.cvss}}
                                                    </span>
                                                </td>
                                            </tr>
                                            {%endfor%}
                                        </tbody>
                                        <!-- End Body -->
                                    </table>
                                </div>
                                <!-- End Recent Vul -->


                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Target -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h5 class="m-0 font-weight-bold text-primary">Targets: </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <div id="dataTable_wrapper" class="dataTables_wrapper dt-bootstrap4">
                            <!-- Horizontal Table list -->
                            <ul class="nav nav-pills mb-3 nav-fill" id="nav-target" role="tablist">
                                <li class="nav-item">
                                    <a class="nav-link active" id="top-target-tab" data-toggle="pill" href="#top-target"
                                        role="tab" aria-controls="top-target">Targets with most Vulnerabilities</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="recent-target-tab" data-toggle="pill" href="#recent-target"
                                        role="tab" aria-controls="recent-target">Targets with critical
                                        Vulnerabilities</a>
                                </li>
                            </ul>
                            <!-- End Horizontal Table list -->

                            <div class="tab-content">
                                <!-- target_vul_count -->
                                <div class="tab-pane fade show active" id="top-target" role="tabpanel"
                                    aria-labelledby="top-vul-tab">
                                    <table class="table table-bordered dataTable" width="100%" cellspacing="0"
                                        role="grid" aria-describedby="dataTable_info" style="width: 100%;">
                                        <!-- Head -->
                                        <thead>
                                            <tr role="row">
                                                <th rowspan="1" colspan="1" style="">Target</th>
                                                <th rowspan="1" colspan="1" style="">Vulnerabilities</th>
                                            </tr>
                                        </thead>
                                        <!-- End Head -->

                                        <!-- Body -->
                                        <tbody>
                                            {%for item in target_vul_count%}
                                            <tr>
                                                <td>{{item.key}}</td>
                                                <td>{{item.doc_count}}</td>
                                            </tr>
                                            {%endfor%}
                                        </tbody>
                                        <!-- End Body -->
                                    </table>
                                </div>
                                <!-- End target_vul_count -->

                                <!-- Target Vul Critical -->
                                <div class="tab-pane fade" id="recent-target" role="tabpanel"
                                    aria-labelledby="recent-vul-tab">
                                    <table class="table table-bordered dataTable" width="100%" cellspacing="0"
                                        role="grid" aria-describedby="dataTable_info" style="width: 100%;">
                                        <!-- Head -->
                                        <thead>
                                            <tr role="row">
                                                <th rowspan="1" colspan="1" style="">Target</th>
                                                <th rowspan="1" colspan="1" style="">Vulnerabilities</th>
                                            </tr>
                                        </thead>
                                        <!-- End Head -->

                                        <!-- Body -->
                                        <tbody>
                                            {%for item in target_vul_critical%}
                                            <tr>
                                                <td>{{item.key}}</td>
                                                <td>{{item.doc_count}}</td>
                                            </tr>
                                            {%endfor%}
                                        </tbody>
                                        <!-- End Body -->
                                    </table>
                                </div>
                                <!-- End Target Vul Critical -->


                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Hidden data -->
    <!-- Pie chart -->
<input id="vul-low" type="number" value="{{vul_count.low}}" hidden />
<input id="vul-medium" type="number" value="{{vul_count.medium}}" hidden />
<input id="vul-mediumHigh" type="number" value="{{vul_count.mediumHigh}}" hidden />
<input id="vul-high" type="number" value="{{vul_count.high}}" hidden />

    <!-- Auto-refresh form -->
<form id="auto-refresh" action="" method="POST" hidden>
    <input id="auto-refresh-time" type="number" name="auto-refresh-time" hidden>
</form>


<!-- END Hidden data -->

<!-- Chart script -->
<script src="{{url_for('static', filename='js/dashboard/Chart.min.js')}}"></script>
<script src="{{url_for('static', filename='js/dashboard/vul-chartpie.js')}}"></script>
<script src="{{url_for('static', filename='js/dashboard/chart-timeline.js')}}"></script>
<!-- END Chart script -->
<script>
    timelineChartData = JSON.parse({{ json_vul_timeline | tojson }})
</script>
{% endblock %}