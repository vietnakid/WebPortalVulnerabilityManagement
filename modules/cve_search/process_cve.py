import logging
import datetime
import json
import pytz


def processCVE(rawData):
    try:
        processing_data = rawData['hits']
        result = {}
        result['total'] = processing_data['total']
        result['records'] = []
        for hit in processing_data['hits']:
            result['records'].append(generateSource(
                hit['_source'], hit.get('_id')))

        return json.dumps(result)

    except:
        logging.exception(msg="No validated jsonified data to be processed!")


def generateSource(raw_source, id):
    source = {}
    try:
        UTC7 = pytz.timezone('Asia/Ho_Chi_Minh')
        source['id'] = id
        source['target'] = raw_source.get('target')
        source['hostname'] = raw_source.get('hostname')
        source['startTime'] = str(datetime.datetime.fromtimestamp(
            int(raw_source['scanstat']['startTime']), tz=UTC7))
        source['endTime'] = str(datetime.datetime.fromtimestamp(
            int(raw_source['scanstat']['endTime']), tz=UTC7))

    # count cvss
        high = 0
        medium = 0
        low = 0
        if raw_source['weakness'] is not None:
            for cpe in raw_source['weakness']:
                if float(cpe['cvss']) <= 4:
                    low += 1
                elif float(cpe['cvss']) <= 7:
                    medium += 1
                else:
                    high += 1

        source['high'] = high
        source['medium'] = str(medium)
        source['low'] = str(low)
    except:
        logging.exception(msg="Generate Source failed!")
    return source


def processCveDetail(rawData):
    try:
        UTC7 = pytz.timezone('Asia/Ho_Chi_Minh')
        processing_data = rawData['_source']
        result = {}
        result['target'] = processing_data['target']
        result['hostname'] = processing_data.get('hostname')
        result['startTime'] = str(datetime.datetime.fromtimestamp(
            int(processing_data['scanstat']['startTime']), tz=UTC7))
        result['endTime'] = str(datetime.datetime.fromtimestamp(
            int(processing_data['scanstat']['endTime']), tz=UTC7))

        result['weakness'] = processing_data['weakness']
        return result

    except:
        logging.exception(msg="No validated jsonified data to be processed!")
    return result


def generateBody(q):
    if q is None:
        body = {"query": {"match_all": {}}}
    else:
        body = {"query": {"bool": {"should": []}}}
        fields = ["hostname^3", "target^3"]
        list_query = q.split(" ")
        for i in list_query:
            if i != " ":
                q_string = {}
                q_string['query_string'] = {}
                q_string['query_string']['fields'] = fields
                q_string['query_string']['query'] = "*" + i + "*"

                body['query']['bool']['should'].append(q_string)
            else:
                continue
    return json.dumps(body)


def generateSortQuery(sort):
    sort_query = ""
    if sort == "init_asc":
        sort_query = "scanstat.startTime:asc"
    elif sort == "init_desc":
        sort_query = "scanstat.startTime:desc"
    return sort_query
