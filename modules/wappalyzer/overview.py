# Import from standard library
import logging
from datetime import datetime

# Import from third-party
from flask import Flask, render_template, json, request, jsonify, session

# Import local files
import DAO.db_connect as db_connect
from config.config import ElasticConfig
from modules.wappalyzer.process_wappalyzer import processWappalyzer


def wappalyzer_overview():
    try:
        es = db_connect.connect_elasticsearch()
        try:
            paging_from = int(request.args.get('from') or 0)
            paging_size = int(request.args.get('size') or ElasticConfig.DEFAULT_PAGE_SIZE)
            body = {"from": paging_from,
                "size": paging_size,
                "query": {"match_all": {}}}
            rawData = es.search(index=ElasticConfig.WAPPALYZER_INDEX, body=body)
            processed_data = json.loads(processWappalyzer(rawData))
            paging_total = processed_data['total']
            paging = {
                "paging_from": paging_from,
                "paging_size": paging_size,
                "paging_total": paging_total
            }
        except:
            logging.exception(msg="Fail")
            return render_template('404.html')
    except:
        logging.exception(msg="Fail")
        return render_template('404.html')
    session['module'] = "wappalyzer"
    return render_template('wappalyzer.html', response=processed_data, paging=paging)
