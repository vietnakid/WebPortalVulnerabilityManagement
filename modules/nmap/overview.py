# Import from standard library
import logging
from datetime import datetime

# Import from third-party
from flask import Flask, render_template, json, request, jsonify, session

# Import local files
import DAO.db_connect as db_connect
from config.config import ElasticConfig
from modules.nmap.process_nmap import processNmap, generateBody, generateSortQuery

DEFAULT_SORT = "scanstat.startTime:desc"

def nmap_overview():
    try:
        es = db_connect.connect_elasticsearch()
        try:
            # Process sort and body from arguments
            q = request.args.get('q')
            paging_size = int(request.args.get('size') or ElasticConfig.DEFAULT_PAGE_SIZE)
            paging_from = int(request.args.get('page') or 1)
            raw_sort = request.args.get('sort')
            sort_query = DEFAULT_SORT if raw_sort is None else generateSortQuery(raw_sort)
            body = generateBody(q, paging_from, paging_size)

            # Process data
            rawData = es.search(index=ElasticConfig.NMAP_INDEX, body=body, sort=sort_query)

            processed_data = json.loads(processNmap(rawData))
            paging_total = processed_data['total']
            paging = {
                "paging_from": paging_from,
                "paging_size": paging_size,
                "paging_total": paging_total,
                "left_page": max(paging_from - 2, 1),
                "right_page": min(max(paging_from - 2, 1) + 4, math.ceil(paging_total / paging_size))
            }
        except:
            logging.exception(msg="Fail")
    except:
        logging.exception(msg="Fail")
    session['module'] = "nmap"
    session['overview'] = True
    return render_template('nmap.html', response=processed_data, q=q, sorting=sort_query, paging=paging)