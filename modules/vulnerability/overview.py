# Import from standard library
import logging
import datetime
import json
import math

# Import from third-party
from flask import Flask, render_template, json, request, jsonify, session
import pytz

# Import local files
import DAO.db_connect as db_connect
from config.config import ElasticConfig
from modules.dashboard.query_body import DashboardQueryBody
from modules.vulnerability.process_vulnerability import process_vulnerability, generateBody, generateSortQuery
from modules.dashboard.process_dashboard import count_vul



def vulnerability_overview():
    try:
        es = db_connect.connect_elasticsearch()
        try:
            # Chart
            vul_count_raw = es.search(index=ElasticConfig.VULNERABILITY_INDEX, body=DashboardQueryBody.VUL_COUNT)
            vul_count = json.loads(count_vul(vul_count_raw))

            # Process sort and body from arguments
            q = request.args.get('q')
            paging_from = int(request.args.get('page') or 1)
            paging_size = ElasticConfig.DEFAULT_PAGE_SIZE
            if 'size' in request.args:
                paging_size = int(request.args.get('size'))
                session['paging_size'] = paging_size
            elif 'paging_size' in session:
                paging_size = session['paging_size']
            sort = request.args.get('sort')
            index = request.args.get('index')
            if index is None:
                index = "scanstat.startTime"
            if sort is None:
                sort = "desc"
            sort_query = generateSortQuery(sort, index)
            body = generateBody(q, paging_from, paging_size)

            # Process data
            rawData = es.search(
                index=ElasticConfig.VULNERABILITY_INDEX, body=body, sort=sort_query)

            processed_data = process_vulnerability(rawData)
            # Backward version of elasticSearch compatitive
            if type(rawData['hits']['total']) == dict:
                paging_total = rawData['hits']['total']['value']
            else:
                paging_total = rawData['hits']['total']

            paging = {
                "paging_from": paging_from,
                "paging_size": paging_size,
                "paging_total": paging_total,
                "left_page": max(paging_from - 2, 1),
                "right_page": min(max(paging_from - 2, 1) + 4, math.ceil(paging_total / paging_size))
            }
            if sort == "desc":
                sort = "asc"
            else:
                sort = "desc"
        except:
            logging.exception(msg="Fail!")
    except:
        logging.exception(msg="Fail")
    session['module'] = "vulnerability"
    session['overview'] = True
    return render_template('vulnerability.html', response=processed_data, q=q, sorting=sort, index=index, paging=paging, vul_count=vul_count)
