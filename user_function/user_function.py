import logging

from flask import Flask, render_template, request, session

from DAL import user_dal
import re

def get_user_data(result=""):
    try:
        userid = session['userid']
        user = user_dal.get_user_by_id(userid)
        return render_template('profile.html', user=user, result=result)
    except:
        logging.exception(msg="Fail")

def update_user():
    try:
        userid = session['userid']
        fullname = request.form['fullname']
        if fullname == "":
            return get_user_data(result="Full name can't be blank")
        result = user_dal.update_user(userid, fullname)
        if result:
            return get_user_data(result="Update successful")
        return get_user_data(result="Failed to update")
    except:
        logging.exception(msg="Fail")

def change_password():
    try:
        userid = session['userid']
        current_password = request.form['current_password']
        new_password = request.form['new_password']
        re_new_password = request.form['re_new_password']
        
        if not user_dal.check_current_password(userid, current_password):
            return render_template('change-password.html', result="Current password is not correct")
        elif not new_password == re_new_password:
            return render_template('change-password.html', result="Re-enter password not match")
        elif not validate_password(new_password):
            return render_template('change-password.html', result="Password is not validated")
        result = user_dal.change_password(userid, new_password)
        if result:
            return render_template('change-password.html', result="Change pasword successful")
        return render_template('change-password.html', result="Failed to change password")
    except:
        logging.exception(msg="Fail")

def validate_password(password):
    regex = "(?=^.{8,}$)((?=.*\d)|(?=.*\W+))(?![.\n])(?=.*[A-Z])(?=.*[a-z]).*$"
    if re.match(regex, password):
        return True
    return False