$(document).ready(function () {

    // Init RegEx
    const REGEX_IP = /^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$/g;
    const REGEX_IP_RANGE = /^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(3[0-2]|[1-2][0-9]|[0-9]))$/g;
    const REGEX_DOMAIN = /^(?!:\/\/)([a-zA-Z0-9-_]+\.)*[a-zA-Z0-9][a-zA-Z0-9-_]+\.[a-zA-Z]{2,11}?$/igm;
    const TODAY = new Date();

    // New Scan
    $("#scanForm").on('submit', function(event){
        var form_data = {
            name : $('#name').val(),
            description: $('#description').val(),
            scan_type: $("[name='scan_type']:checked").val(),
            scan_time_epoch: $('#my_epoch').val(),
            created_time_epoch: parseInt(TODAY.getTime() / 1000.0),
            interval: $('#interval').val(),
            target: $('#target').val(),
        }

        $.ajax({
            type: 'POST',
            url: '/newscan/create',
            // contentType: false,
            // contentType: "application/json; charset=utf-8",
            // dataType : 'json',
            data: form_data,
            success: function(resp){
                if(resp === "Success") $('#noti').text("Create scan successfully!");
                else if(resp === "Fail") $('#noti').text("Create scan failed!");
                $('#noti').show();
            },
        });
        event.preventDefault();
    })

    $('#btnSubmit').click(function () {
        if (!validateName()) return false;
        if (!validateScanType()) return false;
        if (!validateTarget()) return false;

        var scanTimeDate = TODAY;
        if (parseInt($('#scan_time_type').val()) === 2) {
            scanTimeDate = new Date($('#scan_time').val());
            if (scanTimeDate < TODAY) {
                $('#noti').text("Cannot input a date from the pass!");
                $('#noti').show();
                return false;
            }
        }
        var scanTimeEpoch = parseInt(scanTimeDate.getTime() / 1000.0);
        $('#my_epoch').val(scanTimeEpoch);


        $('#noti').text("");
        $('#noti').hide();
        $("#scanForm").submit();
    })

    function validateName() {
        if ($('#name').val() === "") {
            $('#noti').text("Please input scan Name!");
            $('#noti').show();
            return false;
        } else return true;
    }

    function validateTarget() {
        var targetRaw = $('#target').val();
        if (targetRaw === "") {
            $('#noti').text("Target cannot be empty!");
            $('#noti').show();
            return false;
        } else {
            var targets = [];
            if(!targetRaw.includes(" ")) 
                targets.push(targetRaw);
            else 
                targets = targetRaw.split(" ");

            for (let i = 0; i < targets.length; i++) {
                if (targets[i].match(REGEX_IP) !== null ||
                    targets[i].match(REGEX_IP_RANGE) !== null ||
                    targets[i].match(REGEX_DOMAIN) !== null) continue;
                else {
                    $('#noti').text("Please enter valid IP, IP range or domain separated by space!");
                    $('#noti').show();
                    return false;
                }
            }
            return true;
        }
    }

    function validateScanType() {
        if (parseInt($('#scan_time_type').val()) === 2 && $('#scan_time').val() === "") {
            $('#noti').text("Please enter a time to scan!");
            $('#noti').show();
            return false;
        } else return true;
    }

    $('#sort').change(function () {
        changeValue = parseInt($(this).val());
        currentURL = document.location.href;
        sortInitDesc = "init_desc";
        sortInitAsc = "init_asc";

        if (currentURL.includes(sortInitDesc) && changeValue === 1 ||
            !currentURL.includes("sort") && changeValue === 1 ||
            currentURL.includes(sortInitAsc) && changeValue === 2) {
            return;
        } else {
            toBeSort = changeValue === 1 ? sortInitDesc : sortInitAsc;
            url = new URL(currentURL);
            url.searchParams.set('sort', toBeSort);
            window.location.href = url;
            return;
        }
    })

    $('#scan_time_type').change(function () {
        var scan = parseInt($('#scan_time_type').val());
        if (scan === 2) {
            $('#scan_time_picker').css("display", "block");
        } else {
            $('#scan_time_picker').css("display", "none");
        }
    })


});